<div class="cart-page">
  <!-- Header com navegação melhorada -->
  <header class="cart-header">
    <div class="container">
      <button class="back-button" routerLink="/catalogo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Continuar Comprando
      </button>
      <h1>Seu Carrinho</h1>
      <div class="step-indicator" *ngIf="isAuthenticated && items.length > 0">
        <div class="step" [class.active]="!showAddressForm">
          <div class="step-number">1</div>
          <span>Carrinho</span>
        </div>
        <div class="step-line"></div>
        <div class="step" [class.active]="showAddressForm">
          <div class="step-number">2</div>
          <span>Endereço</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Estado vazio -->
  <section *ngIf="items.length === 0" class="empty-state">
    <div class="container">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="9" cy="21" r="1"/>
        <circle cx="20" cy="21" r="1"/>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
      </svg>
      <h2>Seu carrinho está vazio</h2>
      <p>Adicione produtos ao carrinho para continuar sua compra.</p>
      <a routerLink="/catalogo" class="btn-primary">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        Explorar Produtos
      </a>
    </div>
  </section>

  <!-- Carrinho com itens -->
  <section *ngIf="items.length > 0 && !showAddressForm" class="cart-content">
    <div class="container">
      <div class="cart-grid">

        <!-- Lista de produtos -->
        <div class="products-list">
          <div class="list-header">
            <h2>Produtos ({{ itemCount }})</h2>
            <button class="btn-text" (click)="clear()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
              Limpar Carrinho
            </button>
          </div>

          <div class="cart-items">
            <div class="cart-item" *ngFor="let item of items">
              <div class="item-image">
                <img [src]="item.image" [alt]="item.name">
              </div>
              <div class="item-details">
                <h3>{{ item.name }}</h3>
                <div class="item-price">{{ item.price | currency:'BRL' }}</div>
                <div class="quantity-control">
                  <button (click)="dec(item)" class="qty-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                  </button>
                  <span class="qty-value">{{ item.qty }}</span>
                  <button (click)="inc(item)" class="qty-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <line x1="12" y1="5" x2="12" y2="19"/>
                      <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="item-total">
                <div class="total-label">Total</div>
                <div class="total-value">{{ (item.price * item.qty) | currency:'BRL' }}</div>
                <button class="btn-remove" (click)="remove(item)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                  Remover
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Resumo do pedido -->
        <div class="order-summary">
          <h3>Resumo do Pedido</h3>

          <div class="summary-lines">
            <div class="summary-line">
              <span>Subtotal ({{ itemCount }} {{ itemCount === 1 ? 'item' : 'itens' }})</span>
              <strong>{{ subtotal | currency:'BRL' }}</strong>
            </div>
            <div class="summary-line">
              <span>Frete</span>
              <strong *ngIf="frete === 0" class="free-shipping">GRÁTIS</strong>
              <strong *ngIf="frete > 0">{{ frete | currency:'BRL' }}</strong>
            </div>
            <div class="summary-line total-line">
              <span>Total</span>
              <strong>{{ totalComFrete | currency:'BRL' }}</strong>
            </div>
          </div>

          <div class="shipping-info" *ngIf="subtotal < 200">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
            </svg>
            <p>Faltam <strong>{{ (200 - subtotal) | currency:'BRL' }}</strong> para frete grátis!</p>
          </div>
          <div class="shipping-info success" *ngIf="subtotal >= 200">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <p>Você ganhou <strong>frete grátis!</strong></p>
          </div>

          <!-- Botões baseados em autenticação -->
          <div class="checkout-actions">
            <button *ngIf="!isAuthenticated" class="btn-checkout" (click)="proceedToCheckout()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"/>
              </svg>
              Fazer Login para Continuar
            </button>
            <button *ngIf="isAuthenticated" class="btn-checkout" (click)="proceedToCheckout()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M9 11l3 3L22 4"/>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
              </svg>
              Continuar para Endereço
            </button>
            <a routerLink="/catalogo" class="btn-secondary">Adicionar Mais Produtos</a>
          </div>

          <div class="trust-badges">
            <div class="badge">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
              </svg>
              <span>Compra Segura</span>
            </div>
            <div class="badge">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M9 11l3 3L22 4"/>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
              </svg>
              <span>Garantia Estendida</span>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- Formulário de Endereço -->
  <section *ngIf="showAddressForm" class="address-form-section">
    <div class="container">
      <button class="back-button" (click)="showAddressForm = false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Voltar ao Carrinho
      </button>

      <div class="form-container">
        <div>
          <h2>Endereço de Entrega</h2>
          <p class="form-subtitle">Preencha os dados para finalizar seu pedido</p>

          <form class="address-form" (ngSubmit)="finalizarPedido()">
          <div class="form-row">
            <div class="form-group">
              <label for="cep">CEP *</label>
              <input
                type="text"
                id="cep"
                [(ngModel)]="endereco.cep"
                name="cep"
                (blur)="buscarCEP()"
                placeholder="00000-000"
                required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group full">
              <label for="logradouro">Logradouro *</label>
              <input
                type="text"
                id="logradouro"
                [(ngModel)]="endereco.logradouro"
                name="logradouro"
                placeholder="Rua, Avenida, etc."
                required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="numero">Número *</label>
              <input
                type="text"
                id="numero"
                [(ngModel)]="endereco.numero"
                name="numero"
                placeholder="123"
                required>
            </div>
            <div class="form-group">
              <label for="complemento">Complemento</label>
              <input
                type="text"
                id="complemento"
                [(ngModel)]="endereco.complemento"
                name="complemento"
                placeholder="Apto, Bloco, etc.">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="bairro">Bairro *</label>
              <input
                type="text"
                id="bairro"
                [(ngModel)]="endereco.bairro"
                name="bairro"
                placeholder="Centro"
                required>
            </div>
            <div class="form-group">
              <label for="cidade">Cidade *</label>
              <input
                type="text"
                id="cidade"
                [(ngModel)]="endereco.cidade"
                name="cidade"
                placeholder="São Paulo"
                required>
            </div>
            <div class="form-group small">
              <label for="estado">UF *</label>
              <input
                type="text"
                id="estado"
                [(ngModel)]="endereco.estado"
                name="estado"
                placeholder="SP"
                maxlength="2"
                required>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-submit" [disabled]="isProcessing">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M9 11l3 3L22 4"/>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
              </svg>
              {{ isProcessing ? 'Processando...' : 'Finalizar Pedido - ' + (totalComFrete | currency:'BRL') }}
            </button>
          </div>
        </form>
        </div>

        <!-- Resumo lateral -->
        <div class="order-sidebar">
          <h3>Resumo</h3>
          <div class="sidebar-items">
            <div class="sidebar-item" *ngFor="let item of items">
              <img [src]="item.image" [alt]="item.name">
              <div class="sidebar-item-info">
                <span class="item-name">{{ item.name }}</span>
                <span class="item-qty">Qtd: {{ item.qty }}</span>
              </div>
              <span class="item-price">{{ (item.price * item.qty) | currency:'BRL' }}</span>
            </div>
          </div>
          <div class="sidebar-total">
            <span>Total</span>
            <strong>{{ totalComFrete | currency:'BRL' }}</strong>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>
